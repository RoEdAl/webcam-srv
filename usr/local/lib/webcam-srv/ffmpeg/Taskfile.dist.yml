version: '3'

vars:
  FONT_FILE: /usr/share/fonts/truetype/dejavu/DejaVuSans.ttf
  FONT_SIZE: 14
  TIME_TEXT: "%{localtime\\:%x %X}"
  TEXT_COLOR: 'white'
  TEXT_BG_COLOR: 'black@0.25'
  INITIAL_FRAMES_TO_SKIP: 20
  DISCARD_FILTERS:
    - 'setts=ts=if(not(eq(PREV_INPTS,NOPTS)+eq(PREV_INDTS,NOPTS))*(gte(PREV_INPTS,PTS)+gte(PREV_INDTS,DTS)),NOPTS,TS)'
    - 'noise=drop=if(eq(pts,nopts)+eq(dts,nopts)+lte(n,{{.INITIAL_FRAMES_TO_SKIP}}),if(gt(n,{{.INITIAL_FRAMES_TO_SKIP}}),print(n));1,0)'
  DISCARD_FILTER_STR: >-
    {{$f := list -}}
    {{range .DISCARD_FILTERS}}{{$f = append $f (. | replace "," "\\,")}}{{end -}}
    {{$f | join ","}}
  H264_FILTERS:
    - 'h264_mp4toannexb'
    - 'h264_metadata=aud=remove:display_orientation=remove:zero_new_constraint_set_flags=1'
  H264_FILTERS_STR: >-
    {{$f := list -}}
    {{range .H264_FILTERS}}{{$f = append $f (. | replace "," "\\,")}}{{end -}}
    {{$f | join ","}}
  OVERLAY_FILTERS:
    - >-
      [0:v][1:v] overlay=
      x=2:
      y=2:
      enable=lt(mod(t,2),1)
    - >-
      drawtext=
      fontfile='{{.FONT_FILE}}':
      fontsize={{.FONT_SIZE}}:
      text='{{.TIME_TEXT}}':
      fontcolor={{.TEXT_COLOR}}:
      alpha=0.75:
      box=1:
      boxcolor={{.TEXT_BG_COLOR}}:
      boxborderw=2:
      x=w-text_w-4:
      y=4
  OVERLAY_FILTER_STR: >-
    {{$f := list -}}
    {{range .OVERLAY_FILTERS}}{{$f = append $f (. | replace "," "\\,")}}{{end -}}
    {{$f | join ","}}
  KNOWN_OPTS:
    map:
      common:
        - xerror
        - hide_banner
        - [loglevel, 'repeat+info']
        - nostats
        - copyts
        - [filter_threads, 1]
        - [filter_complex_threads, 1]
        - [thread_queue_size, 32]
      video-overlay-input:
        - [width, 22]
        - [height, 22]
        - [i, '{{joinPath .TASKFILE_DIR "webcam.svg"}}']
      video-overlay-filter:
        - [filter_complex, '{{.OVERLAY_FILTER_STR}}']
      rtsp:
        - [rtsp_transport, tcp]
        - [tcp_nodelay, 1]
        - [f, rtsp]
      discard:
        - [discard, noref]
        - ['bsf:v', '{{.DISCARD_FILTER_STR}}']
      h264-bsf:
        - ['bsf:v', '{{.H264_FILTERS_STR}}']

tasks:
  cmdline:
    desc: Generate path node configuration from specified options and arguments of ffmpeg
    internal: true
    requires:
      vars:
        - FF_OPTS
        - FF_ARGS
    cmds:
      - cmd: |
          {{$opts := list}}{{$ko := .KNOWN_OPTS -}}
          {{range $o := .FF_OPTS -}}
            {{if kindIs "string" $o -}}
              {{if hasPrefix "#" $o -}}
                {{with $k := trimPrefix "#" $o -}}
                  {{if hasKey $ko $k -}}
                    {{$opts = get $ko $k | concat $opts -}}
                  {{end -}}
                {{end -}}
                {{continue -}}
              {{end -}}
            {{end -}}
            {{$opts = append $opts . -}}
          {{end -}}
          {{$cmd := list "ffmpeg" -}}
          {{range $p := $opts -}}
            {{if kindIs "string" $p -}}
              {{$cmd = list "-" $p | join "" | shellQuote | append $cmd -}}
            {{else -}}
              {{$cmd = list "-" (first $p) | join "" | shellQuote | append $cmd -}}
              {{range $r := rest $p | toStrings}}{{$cmd = shellQuote $r | append $cmd}}{{end -}}
            {{end -}}
          {{end -}}
          {{range $p := .FF_ARGS -}}
            {{$cmd = shellQuote $p | append $cmd -}}
          {{end -}}
          echo {{ $cmd | join " " | toJson | b64enc | shellQuote -}}

  cmdline-ex:
    desc: Generate path node configuration from specified options and arguments of ffmpeg
    requires:
      vars:
        - FF_OPTS
        - FF_ARGS
    cmds:
      - task: cmdline
        vars:
          FF_ARGS:
            ref: '.FF_ARGS | b64dec | fromJson'
          FF_OPTS:
            ref: '.FF_OPTS | b64dec | fromJson'

  shell-script:
    desc: Generate shell script from specified options and arguments of ffmpeg
    requires:
      vars:
        - FF_OPTS
        - FF_ARGS
        - FF_SCRIPT
    cmds:
      - cmd: |
          {{$opts := list}}{{$ko := .KNOWN_OPTS -}}
          {{range $o := .FF_OPTS -}}
            {{if kindIs "string" $o -}}
              {{if hasPrefix "#" $o -}}
                {{with $k := trimPrefix "#" $o -}}
                  {{if hasKey $ko $k -}}
                    {{$opts = get $ko $k | concat $opts -}}
                  {{end -}}
                {{end -}}
                {{continue -}}
              {{end -}}
            {{end -}}
            {{$opts = append $opts . -}}
          {{end -}}
          cat << 'EOS' > /run/mediamtx/{{.FF_SCRIPT}}
          #!/bin/bash -e

          exec ffmpeg \
          {{range $p := $opts -}}{{"  " -}}
          {{- if kindIs "string" $p -}}
            {{list "-" $p | join "" | shellQuote -}}
          {{else -}}
            {{list "-" (first $p) | join "" | shellQuote -}}
            {{range $r := rest $p | toStrings}} {{shellQuote $r}}{{end -}}
          {{end}} \
          {{end -}}
          {{range $p := initial .FF_ARGS -}}
          {{"  "}}{{shellQuote $p}} \
          {{end -}}
          {{"  "}}{{last .FF_ARGS | shellQuote}}
          EOS
      - cmd: cat /run/mediamtx/{{.FF_SCRIPT}} 1>&2
      - cmd: chmod +x /run/mediamtx/{{.FF_SCRIPT}}

