version: '3'

vars:
  HW_ENCODER_DEV_PATH: /dev/video11
  MEDIAMTX_CONFIG_PATH: /usr/local/etc/mediamtx.yml
  WEBCAM_CONFIG_PATH: /usr/local/etc/webcam-srv.yml
  DEF_CFG:
    map:
      framerate: 10
      video_size: vga
      h264:
        num_capture_buffers: 8
        num_output_buffers: 16
        b: 800k
        bf: 0

definitions:
  get-webcam-data:
    requires: &webcam-requires
      vars:
        - WEBCAM_PATH
        - WEBCAM_JSON
        - RTSP_PORT
  get-webcam-vars:
    vars: &webcam-vars
      V4L_DEV: &v4l_dev '/dev/v4l/{{.WEBCAM_PATH}}'
      WEBCAM_NAME_UDEV: &webcam_name_udev
        sh: 'udevadm info -q property --property=ID_V4L_PRODUCT --value {{shellQuote .V4L_DEV}} || true'
      WEBCAM_NAME_DEF: &webcam_name_def '{{.WEBCAM_NAME_UDEV | default (list "WebCam" .WEBCAM_PATH | join ":" )}}'
      WEBCAM_CFG: &webcam_cfg
        ref: fromJson .WEBCAM_JSON
      WEBCAM_NAME: &webcam_name '{{.WEBCAM_CFG | dig .WEBCAM_PATH "name" .WEBCAM_NAME_DEF}}'
      RTSP_URI: &rtsp_uri 'rtsp://localhost:{{.RTSP_PORT | default 8554}}/{{.WEBCAM_PATH}}'

  get-hw-encoder-data:
    preconditions: &hw-encoder-preconditions
      - sh: test -c {{.HW_ENCODER_DEV_PATH}}
        msg: Hardware H.264 encoder not found
    vars: &hw-encoder-vars
      HW_ENCODER_V4L_PRODUCT: &hw_encoder_v4l_product
        sh: 'udevadm info -q property --property=ID_V4L_PRODUCT --value {{.HW_ENCODER_DEV_PATH}} || true'
      HW_ENCODER_NAME: &hw_encoder_name '{{.HW_ENCODER_V4L_PRODUCT | default "Hardware Codec"}}'

  FF_OPTS: &ff_opts
    - '#common'
    - '#discard'
    - [f, v4l2]
    - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
    - [input_format, '{{.INPUT_FORMAT}}']
    - [framerate, '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}']
    - [i, '{{.V4L_DEV}}']
    - ['fps_mode:v', vfr]
    - ['c:v', copy]
    - [map_metadata, -1]
    - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
    - ['metadata:s:v', 'encoder={{.WEBCAM_NAME}}']
    - '#{{.INPUT_FORMAT}}-bsf'
    - '#rtsp'
  FF_ARGS: &ff_args
    - '{{.RTSP_URI}}'
  RE_FF_OPTS: &re_ff_opts
    - '#common'
    - '#discard'
    - [rtsp_transport, tcp]
    - [framerate, '{{.FRAMERATE}}']
    - [i, '{{.RTSP_URI}}']        
    - ['fps_mode:v', vfr]
    - ['c:v', h264_v4l2m2m]
    - [pix_fmt, yuv420p]
    - ['num_capture_buffers:v', '{{.WEBCAM_CFG | dig "h264" "num_capture_buffers" .DEF_CFG.h264.num_capture_buffers}}']
    - ['num_output_buffers:v', '{{.WEBCAM_CFG | dig "h264" "num_capture_buffers" .DEF_CFG.h264.num_output_buffers}}']
    - ['g:v', '{{.WEBCAM_CFG | dig "h264" "g" .FRAMERATE}}']
    - ['b:v', '{{.WEBCAM_CFG | dig "h264" "b" .DEF_CFG.h264.b}}']
    - ['bf:v', '{{.WEBCAM_CFG | dig "h264" "bf" .DEF_CFG.h264.bf}}']
    - '#h264-bsf'
    - [map_metadata, -1]
    - ['metadata:g', 'title={{.WEBCAM_NAME}}']
    - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
    - ['metadata:s:v', 'encoder={{.HW_ENCODER_NAME}}']
    - '#rtsp'
  RE_FF_ARGS: &re_ff_args
    - '{{.RTSP_URI}}-enc'

  FF_CMDLINE_B64: &ff_cmdline_b64
    sh: >-
      env
      {{.FF_OPTS | toJson | b64enc | list "FF_OPTS" | join "=" | shellQuote}}
      {{.FF_ARGS | toJson | b64enc | list "FF_ARGS" | join "=" | shellQuote}}
      {{.TASK_EXE}} -s -x -d {{joinPath .TASKFILE_DIR "ffmpeg"}} cmdline-ex
  FF_CMDLINE: &ff_cmdline
    ref: .FF_CMDLINE_B64 | b64dec | fromJson      
  RE_FF_CMDLINE_B64: &re_ff_cmdline_b64
    sh: >-
      env
      {{.RE_FF_OPTS | toJson | b64enc | list "FF_OPTS" | join "=" | shellQuote}}
      {{.RE_FF_ARGS | toJson | b64enc | list "FF_ARGS" | join "=" | shellQuote}}
      {{.TASK_EXE}} -s -x -d {{joinPath .TASKFILE_DIR "ffmpeg"}} cmdline-ex      
  RE_FF_CMDLINE: &re_ff_cmdline
    ref: .RE_FF_CMDLINE_B64 | b64dec | fromJson

tasks:
  capture-v4l:
    desc: Capture and publish stream from V4L device
    internal: true
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "mjpeg"}}'
      FF_OPTS: *ff_opts
      FF_ARGS: *ff_args
      FF_CMDLINE_B64: *ff_cmdline_b64
      FF_CMDLINE: *ff_cmdline
      PATH_DEF:
        map:
          runOnInit: '{{.FF_CMDLINE}}'
          runOnInitRestart: true
    cmds:
      - echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  encode-h264:
    desc: Capture video from V4L device and encode to H264 stream using hardware encoder then publish encoded stream
    internal: true
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "yuyv422"}}'
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      HW_ENCODER_V4L_PRODUCT: *hw_encoder_v4l_product
      HW_ENCODER_NAME: *hw_encoder_name
      FF_OPTS:
        - '#common'
        - '#discard'
        - [f, v4l2]
        - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
        - [input_format, '{{.INPUT_FORMAT}}']
        - [framerate, '{{.FRAMERATE}}']
        - [i, '{{.V4L_DEV}}']
        - ['fps_mode:v', vfr]
        - ['c:v', h264_v4l2m2m]
        - [pix_fmt, yuv420p]
        - ['num_capture_buffers:v', '{{.WEBCAM_CFG | dig "h264" "num_capture_buffers" .DEF_CFG.h264.num_capture_buffers}}']
        - ['num_output_buffers:v', '{{.WEBCAM_CFG | dig "h264" "num_output_buffers" .DEF_CFG.h264.num_output_buffers}}']
        - ['g:v', '{{.WEBCAM_CFG | dig "h264" "g" .FRAMERATE}}']
        - ['b:v', '{{.WEBCAM_CFG | dig "h264" "b" .DEF_CFG.h264.b}}']
        - ['bf:v', '{{.WEBCAM_CFG | dig "h264" "bf" .DEF_CFG.h264.bf}}']
        - '#h264-bsf'
        - [map_metadata, -1]
        - ['metadata:g', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'encoder={{.HW_ENCODER_NAME}}']
        - '#rtsp'
      FF_ARGS:
        - '{{.RTSP_URI}}'
      FF_CMDLINE_B64: *ff_cmdline_b64
      FF_CMDLINE: *ff_cmdline
      PATH_DEF:
        map:
          runOnInit: '{{.FF_CMDLINE}}'
          runOnInitRestart: true        
    cmds:
      - echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  re-encode-h264:
    desc: Captrue video stream from V4l device. Publish original stream from device and re-encoded H264 stream
    internal: true
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "mjpeg"}}'
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      RTSP_URI: *rtsp_uri
      HW_ENCODER_V4L_PRODUCT: *hw_encoder_v4l_product
      HW_ENCODER_NAME: *hw_encoder_name
      FF_OPTS: *ff_opts
      FF_ARGS: *ff_args
      FF_CMDLINE_B64: *ff_cmdline_b64
      FF_CMDLINE: *ff_cmdline
      RE_FF_OPTS: *re_ff_opts
      RE_FF_ARGS: *re_ff_args
      RE_FF_CMDLINE_B64: *re_ff_cmdline_b64
      RE_FF_CMDLINE: *re_ff_cmdline
      PATH_DEF:
        map:
          runOnInit: '{{.FF_CMDLINE}}'
          runOnInitRestart: true
          runOnReady: '{{.RE_FF_CMDLINE}}'
          runOnReadyRestart: true
    cmds:
      - echo {{dict .WEBCAM_PATH .PATH_DEF (list .WEBCAM_PATH "enc" | join "-") (dict) | toJson | b64enc | shellQuote}}

  webcam-disabled:
    internal: true

  webcam-paths:
    desc: Webcam paths
    vars:
      WEBCAM_CONFIG_STR:
        sh: cat {{joinPath (.DSTDIR | default "") .WEBCAM_CONFIG_PATH}}
      WEBCAM_CONFIG:
        ref: fromYaml .WEBCAM_CONFIG_STR
      WEBCAMS:
        ref: get .WEBCAM_CONFIG "webcams"
    cmds:
      - for: { var: WEBCAMS }
        task: >-
          {{$enable := .ITEM | dig "enable" true -}}
          {{if $enable | kindIs "bool" | not }}{{fail "\"enable\" must have a boolean value"}}{{end -}}
          {{if $enable}}{{.ITEM | dig "mode" "capture-v4l"}}{{else}}webcam-disabled{{end}}
        vars:
          WEBCAM_PATH: '{{.KEY}}'
          WEBCAM_JSON: '{{toJson .ITEM}}'
          RTSP_PORT: '{{.RTSP_PORT | default 8554}}'

  internal-webcam-ctrls:
    internal: true
    requires:
      vars:
        - V4L_DEV
        - V4L_CTRLS
    vars:
      CTRLS_STR: >-
        {{$c := list -}}
        {{range $ctrl, $val := .V4L_CTRLS | fromJson -}}
          {{$c = list $ctrl ($val | toString) | join "=" | append $c -}}
        {{end -}}
        {{$c | join "," -}}
    cmds:
      - cmd: '{{if empty .CTRLS_STR | not }}v4l2-ctl -d {{.V4L_DEV}} --set-ctrl {{.CTRLS_STR}}{{end}}'
        ignore_error: true

  webcam-ctrls:
    desc: Webcam controls
    vars:
      WEBCAM_CONFIG_STR:
        sh: cat {{joinPath (.DSTDIR | default "") .WEBCAM_CONFIG_PATH}}
      WEBCAM_CONFIG:
        ref: fromYaml .WEBCAM_CONFIG_STR
      WEBCAMS:
        ref: get .WEBCAM_CONFIG "webcams"
    cmds:
      - for: { var: WEBCAMS }
        task: >-
          {{$enable := .ITEM | dig "enable" true -}}
          {{if $enable | kindIs "bool" | not }}{{fail "\"enable\" must have a boolean value"}}{{end -}}
          {{if hasKey .ITEM "ctrls" | and $enable}}internal-webcam-ctrls{{else}}webcam-disabled{{end}}
        vars:
          V4L_DEV: /dev/v4l/{{.KEY}}
          V4L_CTRLS: '{{.ITEM | dig "ctrls" (dict) | toJson}}'

  default:
    desc: Create configuration file for MediaMTX service
    aliases:
      - make-config-file
    vars:
      MEDIAMTX_CONFIG_STR:
        sh: cat {{joinPath (.DSTDIR | default "") .MEDIAMTX_CONFIG_PATH}}
      MEDIAMTX_CONFIG:
        ref: fromYaml .MEDIAMTX_CONFIG_STR
      WEBCAM_PATHS:
        sh: >-
          {{.TASK_EXE}} -x -s -d {{.TASKFILE_DIR}} webcam-paths
    cmds:
      - cmd: >-
          {{$paths := .MEDIAMTX_CONFIG | dig "paths" (dict) -}}
          {{range $l :=  .WEBCAM_PATHS | splitLines -}}
            {{if $l | empty}}{{continue}}{{end -}}
            {{range $path, $pdef := $l | b64dec | fromJson -}}
              {{$_ := set $paths $path $pdef -}}
            {{end -}}
          {{end -}}
          {{$_ := set .MEDIAMTX_CONFIG "paths" $paths -}}
          echo {{.MEDIAMTX_CONFIG | toYaml | shellQuote}}{{if .CLI_ARGS_LIST | empty | not}} > {{index .CLI_ARGS_LIST 0 | shellQuote}}{{end -}}
