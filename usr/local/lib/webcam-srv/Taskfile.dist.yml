version: '3'

includes:
  ffmpeg:
    taskfile: ffmpeg
    internal: true

vars:
  HW_ENCODER_DEV_PATH: /dev/video11
  MEDIAMTX_CONFIG_PATH: /usr/local/etc/mediamtx.yml
  WEBCAM_CONFIG_PATH: /usr/local/etc/webcam-srv.yml
  DEF_CFG:
    map:
      framerate: 10
      video_size: vga
      video_width: 640
      video_height: 480
      h264:
        num_capture_buffers: 8
        num_output_buffers: 16
        b: 600k
        preset: ultrafast
        tune: zerolatency
        profile: main
        crf: 23
      h265:
        num_capture_buffers: 8
        num_output_buffers: 16
        b: 300k
        preset: ultrafast
        tune: zerolatency
        profile: main
        crf: 28

definitions:
  get-webcam-data:
    requires: &webcam-requires
      vars:
        - WEBCAM_PATH
        - WEBCAM_JSON
        - RTSP_PORT
  get-webcam-vars:
    vars: &webcam-vars
      V4L_DEV: &v4l_dev '/dev/v4l/{{.WEBCAM_PATH}}'
      WEBCAM_NAME_UDEV: &webcam_name_udev
        sh: 'udevadm info -q property --property=ID_V4L_PRODUCT --value {{shellQuote .V4L_DEV}} || true'
      WEBCAM_NAME_DEF: &webcam_name_def '{{.WEBCAM_NAME_UDEV | default (list "WebCam" .WEBCAM_PATH | join ":" )}}'
      WEBCAM_CFG: &webcam_cfg
        ref: fromJson .WEBCAM_JSON
      WEBCAM_NAME: &webcam_name '{{.WEBCAM_CFG | dig .WEBCAM_PATH "name" .WEBCAM_NAME_DEF}}'
      RTSP_URI: &rtsp_uri 'rtsp://localhost:{{.RTSP_PORT | default 8554}}/{{.WEBCAM_PATH}}'

  get-hw-encoder-data:
    preconditions: &hw-encoder-preconditions
      - sh: test -c {{.HW_ENCODER_DEV_PATH}}
        msg: Hardware H.264 encoder not found
    vars: &hw-encoder-vars
      HW_ENCODER_V4L_PRODUCT: &hw_encoder_v4l_product
        sh: 'udevadm info -q property --property=ID_V4L_PRODUCT --value {{.HW_ENCODER_DEV_PATH}} || true'
      HW_ENCODER_NAME: &hw_encoder_name '{{.HW_ENCODER_V4L_PRODUCT | default "Hardware Codec"}}'

  FF_CMDLINE_B64: &ff_cmdline_b64
    sh: >-
      env
      {{.FF_OPTS | toJson | b64enc | list "FF_OPTS" | join "=" | shellQuote}}
      {{.FF_ARGS | toJson | b64enc | list "FF_ARGS" | join "=" | shellQuote}}
      {{.TASK_EXE}} -s -x -d {{joinPath .TASKFILE_DIR "ffmpeg"}} cmdline-ex
  FF_CMDLINE: &ff_cmdline
    ref: .FF_CMDLINE_B64 | b64dec | fromJson

  cmds-return-path: &return-path
    - &return-path-cmd cmd: echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  rnd_port: &rnd_port
    ref: randIntN 1000 | add 50712

tasks:
  ffmpeg-capture:
    desc: Capture and publish stream from V4L device [ffmpeg]
    internal: true
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "mjpeg"}}'
      FF_OPTS:
      - '#common'
      - '#discard'
      - [f, v4l2]
      - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
      - [input_format, '{{.INPUT_FORMAT}}']
      - [framerate, '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}']
      - [i, '{{.V4L_DEV}}']
      - ['fps_mode:v', vfr]
      - ['c:v', copy]
      - [map_metadata, -1]
      - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
      - ['metadata:s:v', 'encoder={{.WEBCAM_NAME}}']
      - '#{{.INPUT_FORMAT}}-bsf'
      - '#rtsp'
      FF_ARGS:
        - '{{.RTSP_URI}}'
      PATH_DEF:
        map:
          runOnInit: '/bin/bash /run/mediamtx/{{.WEBCAM_PATH}}-on-init.sh'
          runOnInitRestart: true
    cmds:
      - task: ffmpeg:shell-script
        vars:
          FF_SCRIPT: '{{.WEBCAM_PATH}}-on-init.sh'
          FF_OPTS:
            ref: .FF_OPTS
          FF_ARGS:
            ref: .FF_ARGS
      - cmd: echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  v4lrtspsrv-capture:
    desc: Capture and publish stream from V4L device [v4lrtspserver]
    internal: true
    aliases:
      - v4l2rtspserver-capture
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_CFG: *webcam_cfg
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      WIDTH: '{{.WEBCAM_CFG | dig "video_width" .DEF_CFG.video_width}}'
      HEIGHT: '{{.WEBCAM_CFG | dig "video_height" .DEF_CFG.video_height}}'
      RND_PORT: *rnd_port
      PATH_DEF:
        map:
          runOnInit: v4l2rtspserver -I localhost -P {{.RND_PORT}} -u {{.WEBCAM_PATH}} -t 5 -s -F {{.FRAMERATE}} -W {{.WIDTH}} -H {{.HEIGHT}} {{.V4L_DEV}}
          runOnInitRestart: true
          source: rtsp://localhost:{{.RND_PORT}}/{{.WEBCAM_PATH}}
          rtspTransport: tcp
    cmds: *return-path
  
  ffmpeg-hw-encode-h264:
    desc: >-
      Capture video from V4L device and encode to H264 stream using hardware encoder
      then publish encoded stream
    internal: true
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "yuyv422"}}'
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      HW_ENCODER_V4L_PRODUCT: *hw_encoder_v4l_product
      HW_ENCODER_NAME: *hw_encoder_name
      FF_OPTS:
        - '#common'
        - '#discard'
        - [f, v4l2]
        - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
        - [input_format, '{{.INPUT_FORMAT}}']
        - [framerate, '{{.FRAMERATE}}']
        - [i, '{{.V4L_DEV}}']
        - ['fps_mode:v', vfr]
        - ['c:v', h264_v4l2m2m]
        - [pix_fmt, yuv420p]
        - ['num_capture_buffers:v', '{{.WEBCAM_CFG | dig "h264" "num_capture_buffers" .DEF_CFG.h264.num_capture_buffers}}']
        - ['num_output_buffers:v', '{{.WEBCAM_CFG | dig "h264" "num_output_buffers" .DEF_CFG.h264.num_output_buffers}}']
        - ['g:v', '{{.WEBCAM_CFG | dig "h264" "g" .FRAMERATE}}']
        - '#h264-bsf'
        - [map_metadata, -1]
        - ['metadata:g', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'encoder={{.HW_ENCODER_NAME}}']
        - [f, mpegts]
      FF_ARGS:
        - 'unix:/run/mediamtx/{{.WEBCAM_PATH}}.sock'
      PATH_DEF:
        map:
          runOnInit: '/bin/bash /run/mediamtx/{{.WEBCAM_PATH}}-on-init.sh'
          runOnInitRestart: true
          source: 'unix+mpegts:///run/mediamtx/{{.WEBCAM_PATH}}.sock'
      cmds:
        - task: ffmpeg:shell-script
          vars:
            FF_SCRIPT: '{{.WEBCAM_PATH}}-on-init.sh'
            FF_OPTS:
              ref: .FF_OPTS
            FF_ARGS:
              ref: .FF_ARGS
        - cmd: echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  ffmpeg-hw-encode-h265:
    desc: >-
      Capture video from V4L device and encode to H265 stream using hardware encoder
      then publish encoded stream
    internal: true
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "yuyv422"}}'
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      HW_ENCODER_V4L_PRODUCT: *hw_encoder_v4l_product
      HW_ENCODER_NAME: '{{.HW_ENCODER_V4L_PRODUCT | default "V4L2 mem2mem HEVC encoder"}}'
      FF_OPTS:
        - '#common'
        - '#discard'
        - [f, v4l2]
        - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
        - [input_format, '{{.INPUT_FORMAT}}']
        - [framerate, '{{.FRAMERATE}}']
        - [i, '{{.V4L_DEV}}']
        - ['fps_mode:v', vfr]
        - ['c:v', hevc_v4l2m2m]
        - [pix_fmt, yuv420p]
        - ['num_capture_buffers:v', '{{.WEBCAM_CFG | dig "h265" "num_capture_buffers" .DEF_CFG.h265.num_capture_buffers}}']
        - ['num_output_buffers:v', '{{.WEBCAM_CFG | dig "h265" "num_output_buffers" .DEF_CFG.h265.num_output_buffers}}']
        - ['g:v', '{{.WEBCAM_CFG | dig "h265" "g" .FRAMERATE}}']
        - '#h265-bsf'
        - [map_metadata, -1]
        - ['metadata:g', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'encoder={{.HW_ENCODER_NAME}}']
        - [f, mpegts]
      FF_ARGS:
        - 'unix:/run/mediamtx/{{.WEBCAM_PATH}}.sock'
      PATH_DEF:
        map:
          runOnInit: '/bin/bash /run/mediamtx/{{.WEBCAM_PATH}}-on-init.sh'
          runOnInitRestart: true
          source: 'unix+mpegts:///run/mediamtx/{{.WEBCAM_PATH}}.sock'
      cmds:
        - task: ffmpeg:shell-script
          vars:
            FF_SCRIPT: '{{.WEBCAM_PATH}}-on-init.sh'
            FF_OPTS:
              ref: .FF_OPTS
            FF_ARGS:
              ref: .FF_ARGS
        - cmd: echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  ffmpeg-encode-h264:
    desc: >-
      Capture video from V4L device and encode to H264 stream using libx264 encoder
      then publish encoded stream
    internal: true
    aliases:
      - v4l2rtspserver-encode-h264
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "yuyv422"}}'
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      FF_OPTS:
        - '#common'
        - '#discard'
        - [f, v4l2]
        - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
        - [input_format, '{{.INPUT_FORMAT}}']
        - [framerate, '{{.FRAMERATE}}']
        - [i, '{{.V4L_DEV}}']
        - '#video-overlay-input'
        - ['fps_mode:v', vfr]
        - ['c:v', libx264]
        - [pix_fmt, yuv420p]
        - '#video-overlay-filter'
        - [preset:v, '{{.WEBCAM_CFG | dig "h264" "preset" .DEF_CFG.h264.preset}}']
        - [tune:v, '{{.WEBCAM_CFG | dig "h264" "tune" .DEF_CFG.h264.tune}}']
        - [profile:v, '{{.WEBCAM_CFG | dig "h264" "profile" .DEF_CFG.h264.profile}}']
        - [crf:v, '{{.WEBCAM_CFG | dig "h264" "crf" .DEF_CFG.h264.crf}}']
        - '#h264-bsf'
        - [map_metadata, -1]
        - ['metadata:g', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
        - [f, mpegts]
      FF_ARGS:
        - 'unix:/run/mediamtx/{{.WEBCAM_PATH}}.sock'
      PATH_DEF:
        map:
          runOnInit: '/bin/bash /run/mediamtx/{{.WEBCAM_PATH}}-on-init.sh'
          runOnInitRestart: true
          source: 'unix+mpegts:///run/mediamtx/{{.WEBCAM_PATH}}.sock'
    cmds:
      - task: ffmpeg:shell-script
        vars:
          FF_SCRIPT: '{{.WEBCAM_PATH}}-on-init.sh'
          FF_OPTS:
            ref: .FF_OPTS
          FF_ARGS:
            ref: .FF_ARGS
      - cmd: echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}

  ffmpeg-encode-h265:
    desc: >-
      Capture video from V4L device and encode to H265 stream using libx265 encoder
      then publish encoded stream
    internal: true
    aliases:
      - v4l2rtspserver-encode-h265
    requires: *webcam-requires
    vars:
      V4L_DEV: *v4l_dev
      WEBCAM_NAME_UDEV: *webcam_name_udev
      WEBCAM_NAME_DEF: *webcam_name_def
      WEBCAM_CFG: *webcam_cfg
      WEBCAM_NAME: *webcam_name
      RTSP_URI: *rtsp_uri
      INPUT_FORMAT: '{{.WEBCAM_CFG | dig "input_format" "yuyv422"}}'
      FRAMERATE: '{{.WEBCAM_CFG | dig "framerate" .DEF_CFG.framerate}}'
      FF_OPTS:
        - '#common'
        - '#discard'
        - [f, v4l2]
        - [video_size, '{{.WEBCAM_CFG | dig "video_size" .DEF_CFG.video_size}}']
        - [input_format, '{{.INPUT_FORMAT}}']
        - [framerate, '{{.FRAMERATE}}']
        - [i, '{{.V4L_DEV}}']
        - '#video-overlay-input'
        - ['fps_mode:v', vfr]
        - ['c:v', libx265]
        - [pix_fmt, yuv420p]
        - '#video-overlay-filter'
        - ['preset:v', '{{.WEBCAM_CFG | dig "h265" "preset" .DEF_CFG.h265.preset}}']
        - ['preset:v', '{{.WEBCAM_CFG | dig "h265" "tune" .DEF_CFG.h265.tune}}']
        - ['profile:v', '{{.WEBCAM_CFG | dig "h265" "profile" .DEF_CFG.h265.profile}}']
        - [crf:v, '{{.WEBCAM_CFG | dig "h265" "crf" .DEF_CFG.h265.crf}}']
        - '#h265-bsf'
        - [map_metadata, -1]
        - ['metadata:g', 'title={{.WEBCAM_NAME}}']
        - ['metadata:s:v', 'title={{.WEBCAM_NAME}}']
        - [f, mpegts]
      FF_ARGS:
        - 'unix:/run/mediamtx/{{.WEBCAM_PATH}}.sock'
      PATH_DEF:
        map:
          runOnInit: '/bin/bash /run/mediamtx/{{.WEBCAM_PATH}}-on-init.sh'
          runOnInitRestart: true
          source: 'unix+mpegts:///run/mediamtx/{{.WEBCAM_PATH}}.sock'
    cmds:
      - task: ffmpeg:shell-script
        vars:
          FF_SCRIPT: '{{.WEBCAM_PATH}}-on-init.sh'
          FF_OPTS:
            ref: .FF_OPTS
          FF_ARGS:
            ref: .FF_ARGS
      - cmd: echo {{dict .WEBCAM_PATH .PATH_DEF | toJson | b64enc | shellQuote}}
  
  webcam-disabled:
    internal: false

  webcam-paths:
    desc: Webcam paths
    vars:
      WEBCAM_CONFIG_STR:
        sh: cat {{joinPath (.DSTDIR | default "") .WEBCAM_CONFIG_PATH}}
      WEBCAM_CONFIG:
        ref: fromYaml .WEBCAM_CONFIG_STR
      WEBCAMS:
        ref: get .WEBCAM_CONFIG "webcams"
      USE_HW_H264_ENCODER:
        ref: .WEBCAM_CONFIG | dig "webcam-srv" "use-hw-h264-encoder" false
    cmds:
      - for: { var: WEBCAMS }
        task: >-
          {{$enable := .ITEM | dig "enable" true -}}
          {{if $enable | kindIs "bool" | not }}{{fail "\"enable\" must have a boolean value"}}{{end -}}
          {{$utility := .ITEM | dig "utility" "ffmpeg" -}}
          {{$use_hw_h264_encoder := .USE_HW_H264_ENCODER -}}
          {{if hasKey .ITEM "use-hw-h264-encoder"}}{{$use_hw_h264_encoder := get .ITEM "use-hw-h264-encoder"}}{{end -}}
          {{if $use_hw_h264_encoder | kindIs "bool" | not }}{{fail "\"use-hw-h264-encoder\" must have a boolean value"}}{{end -}}
          {{if $enable}}{{$utility}}-{{if $use_hw_h264_encoder}}hw-{{end}}{{.ITEM | dig "mode" "capture"}}{{else}}webcam-disabled{{end -}}
        vars:
          WEBCAM_PATH: '{{.KEY}}'
          WEBCAM_JSON: '{{toJson .ITEM}}'
          RTSP_PORT: '{{.RTSP_PORT | default 8554}}'

  internal-webcam-ctrls:
    internal: true
    requires:
      vars:
        - V4L_DEV
        - V4L_CTRLS
    vars:
      CTRLS_STR: >-
        {{$c := list -}}
        {{range $ctrl, $val := .V4L_CTRLS | fromJson -}}
          {{$c = list $ctrl ($val | toString) | join "=" | append $c -}}
        {{end -}}
        {{$c | join "," -}}
    cmds:
      - cmd: '{{if empty .CTRLS_STR | not }}v4l2-ctl -d {{.V4L_DEV}} --set-ctrl {{.CTRLS_STR}}{{end}}'
        ignore_error: true

  webcam-ctrls:
    desc: Webcam controls
    vars:
      WEBCAM_CONFIG_STR:
        sh: cat {{joinPath (.DSTDIR | default "") .WEBCAM_CONFIG_PATH}}
      WEBCAM_CONFIG:
        ref: fromYaml .WEBCAM_CONFIG_STR
      WEBCAMS:
        ref: get .WEBCAM_CONFIG "webcams"
    cmds:
      - for: { var: WEBCAMS }
        task: >-
          {{$enable := .ITEM | dig "enable" true -}}
          {{if $enable | kindIs "bool" | not }}{{fail "\"enable\" must have a boolean value"}}{{end -}}
          {{if hasKey .ITEM "ctrls" | and $enable}}internal-webcam-ctrls{{else}}webcam-disabled{{end}}
        vars:
          V4L_DEV: /dev/v4l/{{.KEY}}
          V4L_CTRLS: '{{.ITEM | dig "ctrls" (dict) | toJson}}'

  default:
    desc: Create configuration file for MediaMTX service
    aliases:
      - make-config-file
    vars:
      MEDIAMTX_CONFIG_STR:
        sh: cat {{joinPath (.DSTDIR | default "") .MEDIAMTX_CONFIG_PATH}}
      MEDIAMTX_CONFIG:
        ref: fromYaml .MEDIAMTX_CONFIG_STR
      WEBCAM_PATHS:
        sh: >-
          {{.TASK_EXE}} -x -s -d {{.TASKFILE_DIR}} webcam-paths
    cmds:
      - cmd: >-
          {{$paths := .MEDIAMTX_CONFIG | dig "paths" (dict) -}}
          {{range $l :=  .WEBCAM_PATHS | splitLines -}}
            {{if $l | empty}}{{continue}}{{end -}}
            {{range $path, $pdef := $l | b64dec | fromJson -}}
              {{$_ := set $paths $path $pdef -}}
            {{end -}}
          {{end -}}
          {{$_ := set .MEDIAMTX_CONFIG "paths" $paths -}}
          echo {{.MEDIAMTX_CONFIG | toYaml | shellQuote}}{{if .CLI_ARGS_LIST | empty | not}} > {{index .CLI_ARGS_LIST 0 | shellQuote}}{{end -}}
